@model List<DOANLTWEB.Models.DonHangViewModel>
@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-header">
    <div class="container-fluid">
        <h1><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</h1>
        <p class="mb-0">Quản lý và theo dõi đơn hàng của khách hàng</p>
    </div>
</div>

<div class="container-fluid">
    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-list"></i> Danh sách đơn hàng</h4>
            <span class="badge bg-primary">@Model.Count đơn hàng</span>
        </div>

        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày đặt</th>
                            <th>Khách hàng</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var donHang in Model)
                        {
                            <tr>
                                <td><strong>#@donHang.MaDon</strong></td>
                                <td>@(donHang.NgayDat?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                <td>@(donHang.TenKhachHang ?? "N/A")</td>
                                <td class="text-success fw-bold">@string.Format("{0:N0}", donHang.TongTien) VNĐ</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select form-select-sm select-trangthai"
                                                data-madon="@donHang.MaDon"
                                                id="select-@donHang.MaDon"
                                                style="min-width: 150px;">
                                            @foreach (var tt in donHang.DanhSachTrangThai)
                                            {
                                                <option value="@tt.MaTT"
                                                        @(tt.MaTT == donHang.MaTT ? "selected" : "")>
                                                    @tt.TenTT
                                                </option>
                                            }
                                        </select>
                                        <button class="btn btn-success btn-sm .btn-cap-nhat-tt"
                                                data-madon="@donHang.MaDon"
                                                title="Cập nhật trạng thái">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="@Url.Action("ChiTietDonHang", "Admin", new { id = donHang.MaDon })"
                                           class="btn btn-info" title="Chi tiết">
                                            <i class="fas fa-eye"></i> Xem
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Không có đơn hàng nào</h5>
                <p class="mb-0">Chưa có đơn hàng nào trong hệ thống.</p>
            </div>
        }
    </div>
</div>

@section scripts {
    <script>
    function capNhatTrangThai(maDon) {
        var selectElement = $('#trangThai_' + maDon);
        var maTT = selectElement.val();

        if (!maTT) {
            alert('Vui lòng chọn trạng thái!');
            return;
        }

        if (confirm('Bạn có chắc muốn cập nhật trạng thái đơn hàng #' + maDon + '?')) {
            $.ajax({
                url: '@Url.Action("CapNhatTrangThai", "Admin")',
                type: 'POST',
                data: {
                    maDon: maDon,
                    maTT: maTT,
                    ghiChu: 'Cập nhật bởi admin'
                },
                success: function (response) {
                    if (response.success) {
                        alert('Cập nhật trạng thái thành công!');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Lỗi kết nối: ' + error);
                    console.error('Chi tiết lỗi:', xhr.responseText);
                }
            });
        }
    }

    // Hoặc dùng event delegation cho nhiều button
    $(document).on('click', '.btn-cap-nhat-tt', function() {
        var maDon = $(this).data('madon');
        capNhatTrangThai(maDon);
    });
    </script>
}