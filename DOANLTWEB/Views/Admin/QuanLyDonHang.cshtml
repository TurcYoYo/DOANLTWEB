@model List<DOANLTWEB.Models.DonHangViewModel>
@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-header">
    <div class="container-fluid">
        <h1><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</h1>
        <p class="mb-0">Quản lý và theo dõi đơn hàng của khách hàng</p>
    </div>
</div>

<div class="container-fluid">
    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-list"></i> Danh sách đơn hàng</h4>
            <span class="badge bg-primary">@Model.Count đơn hàng</span>
        </div>

        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày đặt</th>
                            <th>Khách hàng</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var donHang in Model)
                        {
                            <tr>
                                <td><strong>#@donHang.MaDon</strong></td>
                                <td>@(donHang.NgayDat?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                <td>@(donHang.TenKhachHang ?? "N/A")</td>
                                <td class="text-success fw-bold">@string.Format("{0:N0}", donHang.TongTien) VNĐ</td>
                                <td>
                                    <select class="form-select form-select-sm select-trangthai"
                                            data-madon="@donHang.MaDon"
                                            style="min-width: 150px;">
                                        @foreach (var tt in donHang.DanhSachTrangThai)
                                        {
                                            <option value="@tt.MaTT"
                                                    @(tt.MaTT == donHang.MaTT ? "selected" : "")>
                                                @tt.TenTT
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="@Url.Action("ChiTietDonHang", "Admin", new { id = donHang.MaDon })"
                                           class="btn btn-info" title="Chi tiết">
                                            <i class="fas fa-eye"></i> Xem
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Không có đơn hàng nào</h5>
                <p class="mb-0">Chưa có đơn hàng nào trong hệ thống.</p>
            </div>
        }
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            // Cập nhật trạng thái đơn hàng
            $('.select-trangthai').on('change', function () {
                var maDon = $(this).data('madon');
                var maTT = $(this).val();
                var select = $(this);

                // Disable select trong khi cập nhật
                select.prop('disabled', true);

                $.post('@Url.Action("CapNhatTrangThai", "Admin")',
                    { maDon: maDon, maTT: maTT, ghiChu: 'Cập nhật bởi admin' })
                    .done(function (response) {
                        if (response.success) {
                            // Có thể thêm thông báo thành công nếu muốn
                            console.log(response.message);
                        } else {
                            alert(response.message);
                            // Reset về giá trị cũ nếu lỗi
                            select.val(select.data('old-value'));
                        }
                    })
                    .fail(function () {
                        alert('Lỗi khi cập nhật trạng thái!');
                        select.val(select.data('old-value'));
                    })
                    .always(function () {
                        select.prop('disabled', false);
                    });

                // Lưu giá trị cũ
                select.data('old-value', select.val());
            });
        });
    </script>
}